name: Trigger Rebuild

on:
  push:
    branches: [main]
    paths:
      - 'people/**'
      - 'shipped/**'

jobs:
  rebuild:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Vercel rebuilds
        run: |
          echo "Triggering vibecoder.md rebuild..."
          curl -X POST "${{ secrets.VERCEL_HOOK_VIBECODER }}" || true

          echo "Triggering pages.md rebuild..."
          curl -X POST "${{ secrets.VERCEL_HOOK_PAGES }}" || true

          echo "Triggering shipped.md rebuild..."
          curl -X POST "${{ secrets.VERCEL_HOOK_SHIPPED }}" || true

          echo "All rebuilds triggered!"

  extract-metadata:
    runs-on: ubuntu-latest
    outputs:
      title: ${{ steps.meta.outputs.title }}
      handle: ${{ steps.meta.outputs.handle }}
      date: ${{ steps.meta.outputs.date }}
      category: ${{ steps.meta.outputs.category }}
      url: ${{ steps.meta.outputs.url }}
      tags: ${{ steps.meta.outputs.tags }}
      preview: ${{ steps.meta.outputs.preview }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Extract ship metadata from changed files
        id: meta
        run: |
          # Find new/changed shipped.md files
          CHANGED=$(git diff --name-only HEAD~1 HEAD -- 'shipped/' | head -1)

          if [ -z "$CHANGED" ]; then
            echo "No ship files changed"
            echo "title=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changed file: $CHANGED"

          # Extract handle and date from path: shipped/{handle}/{date}/shipped.md
          HANDLE=$(echo "$CHANGED" | cut -d'/' -f2)
          DATE_PART=$(echo "$CHANGED" | cut -d'/' -f3)
          # Strip any slug suffix from date (e.g., 2026-02-13-feature -> 2026-02-13)
          DATE=$(echo "$DATE_PART" | grep -oE '^[0-9]{4}-[0-9]{2}-[0-9]{2}')

          echo "handle=$HANDLE" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT

          # Parse frontmatter with simple bash (no external deps)
          CONTENT=$(cat "$CHANGED")

          # Extract title from frontmatter
          TITLE=$(echo "$CONTENT" | sed -n '/^---$/,/^---$/p' | grep '^title:' | sed 's/^title: *//' | sed 's/^"//' | sed 's/"$//')
          echo "title=$TITLE" >> $GITHUB_OUTPUT

          # Extract category
          CATEGORY=$(echo "$CONTENT" | sed -n '/^---$/,/^---$/p' | grep '^category:' | sed 's/^category: *//')
          echo "category=$CATEGORY" >> $GITHUB_OUTPUT

          # Extract tags
          TAGS=$(echo "$CONTENT" | sed -n '/^---$/,/^---$/p' | grep '^tags:' | sed 's/^tags: *\[//' | sed 's/\]//' | sed 's/, */ /g')
          echo "tags=$TAGS" >> $GITHUB_OUTPUT

          # Extract preview (first 2 sentences of "The Ship" section)
          PREVIEW=$(echo "$CONTENT" | sed -n '/^## The Ship$/,/^## /p' | grep -v '^##' | head -3 | tr '\n' ' ' | sed 's/  */ /g' | head -c 200)
          echo "preview=$PREVIEW" >> $GITHUB_OUTPUT

          # Build URL
          echo "url=https://shipped.md/$HANDLE/$DATE" >> $GITHUB_OUTPUT

  notify-telegram:
    needs: [rebuild, extract-metadata]
    if: needs.extract-metadata.outputs.title != ''
    runs-on: ubuntu-latest
    steps:
      - name: Post to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
        run: |
          TITLE="${{ needs.extract-metadata.outputs.title }}"
          HANDLE="${{ needs.extract-metadata.outputs.handle }}"
          CATEGORY="${{ needs.extract-metadata.outputs.category }}"
          PREVIEW="${{ needs.extract-metadata.outputs.preview }}"
          TAGS="${{ needs.extract-metadata.outputs.tags }}"
          URL="${{ needs.extract-metadata.outputs.url }}"

          # Format tags as hashtags
          HASHTAGS=$(echo "$TAGS" | tr ' ' '\n' | sed 's/^/#/' | tr '\n' ' ')

          # Build message
          TEXT=$(cat <<EOF
          ðŸš¢ <b>${TITLE}</b>

          by @${HANDLE} Â· ${CATEGORY}

          ${PREVIEW}

          ${HASHTAGS}

          â†’ ${URL}
          EOF
          )

          # Remove leading whitespace from heredoc
          TEXT=$(echo "$TEXT" | sed 's/^          //')

          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHANNEL_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHANNEL_ID}" \
              -d "parse_mode=HTML" \
              -d "text=${TEXT}" \
              -d "disable_web_page_preview=false" || true
            echo "Telegram notification sent!"
          else
            echo "Telegram secrets not configured, skipping notification"
          fi

  # notify-twitter:
  #   needs: [rebuild, extract-metadata]
  #   if: needs.extract-metadata.outputs.title != ''
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Post to X/Twitter
  #       # TODO: Implement with twitter-api-v2 via node script
  #       # Needs secrets: TWITTER_API_KEY, TWITTER_API_SECRET,
  #       #   TWITTER_ACCESS_TOKEN, TWITTER_ACCESS_SECRET
  #       run: echo "Twitter notification placeholder"
